# 5.CRUD的单元测试和数据库之间的交流

## 测试  
利用testing进行自动化测试。
对于testing的具体使用不再做笔记。
本项目中，具体流程是：
建立`main.test`文件，作用是建立和数据库的连接。记得修改对应的用户名和密码。
```go
package db

import (
	"database/sql"
	"log"
	"os"
	"testing"

	_ "github.com/lib/pq"
)

const (
	dbDriver = "postgres"
	dbSource = "postgresql://postgres:password@localhost:5432/simple_bank?sslmode=disable"
)

var testQueries *Queries

func TestMain(m *testing.M) {
	conn, err := sql.Open(dbDriver, dbSource)
	if err != nil {
		log.Fatal("cannot connect to db:", err)
	}

	testQueries = New(conn)

	os.Exit(m.Run())
}

```
对每个函数进行测试。测试完成后数据库，如account.sql.go中的部分如测试成功会被标绿，否则标红。
同时建立了util文件夹存放一些工具，如生成随机用户名等的函数。  
举例，对account.sql.go中的第一个函数进行测试：
```
func createRandomAccount(t *testing.T) Account {
	arg := CreateAccountParams{
		Owner:    util.RandomOwner(),
		Balance:  util.RandomMoney(),
		Currency: util.RandomCurrency(),
	}

	account, err := testQueries.CreateAccount(context.Background(), arg)
	require.NoError(t, err)
	require.NotEmpty(t, account)

	require.Equal(t, arg.Owner, account.Owner)
	require.Equal(t, arg.Balance, account.Balance)
	require.Equal(t, arg.Currency, account.Currency)

	require.NotZero(t, account.ID)
	require.NotZero(t, account.CreatedAt)

	return account
}

func TestCreateAccount(t *testing.T) {
	createRandomAccount(t)
}
```
在vscode中的func ***上面有一行小字，点击run test即可进行单元化的测试，会返回该函数单元测试的结果：成功或对应错误信息。

## ACID 原则  

1. Atomicity
原子性。
2. Consistency
连续性。
3. Isolation
独立性。
4. Durability
稳定性。

## 怎样进行操作
总的来说格式是这样的：
```go
BEGIN;
...
COMMIT;
or
ROLLBACK;
```
剩下部分下次补齐。